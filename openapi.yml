openapi: '3.0.3'
info:
  title: Washing Car API
  version: '0.3'
tags:
  - name: Auth
    description: Аутентификация и регистрация по СМС
  - name: Users
    description: Операции с пользователями
  - name: Cars
    description: Операции с автомобилями
  - name: Appointments
    description: Записи на мойку
  - name: CarWashes
    description: Управление автомойками
  - name: Services
    description: Управление услугами
  - name: Workers
    description: Управление работниками
  - name: Slots
    description: Управление временными слотами

servers:
  - url: http://localhost:3000/api/v1

paths:
  /auth/register:
    post:
      summary: Начало регистрации нового пользователя
      tags:
        - Auth
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - phone
              properties:
                phone:
                  type: string
                  example: '+79123456789'
                name:
                  type: string
                  example: 'Иван'
                email:
                  type: string
                  format: email
                  example: 'ivan@example.com'
      responses:
        '200':
          description: СМС с кодом отправлено
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: 'СМС с кодом отправлено'
        '409':
          description: Пользователь уже существует
        '400':
          description: Неверный формат номера
        '503':
          description: Ошибка отправки СМС

  /auth/verify-registration:
    post:
      summary: Подтверждение регистрации по СМС-коду
      tags:
        - Auth
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - phone
                - code
              properties:
                phone:
                  type: string
                  example: '+79123456789'
                code:
                  type: string
                  example: '123456'
      responses:
        '201':
          description: Регистрация завершена
          content:
            application/json:
              schema:
                type: object
                properties:
                  token:
                    type: string
                    example: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'
                  user:
                    $ref: "#/components/schemas/User"
        '401':
          description: Неверный или просроченный код
        '404':
          description: Регистрация не начата или номер не найден
        '429':
          description: Слишком много попыток

  /auth/login:
    post:
      summary: Запрос кода для входа
      tags:
        - Auth
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - phone
              properties:
                phone:
                  type: string
                  example: '+79123456789'
      responses:
        '200':
          description: СМС с кодом отправлено
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: 'СМС с кодом отправлено'
        '404':
          description: Пользователь не найден
        '400':
          description: Неверный формат номера

  /auth/verify-login:
    post:
      summary: Подтверждение входа по СМС-коду
      tags:
        - Auth
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - phone
                - code
              properties:
                phone:
                  type: string
                  example: '+79123456789'
                code:
                  type: string
                  example: '654321'
      responses:
        '200':
          description: Успешный вход
          content:
            application/json:
              schema:
                type: object
                properties:
                  token:
                    type: string
                    example: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'
                  user:
                    $ref: "#/components/schemas/User"
        '401':
          description: Неверный или просроченный код
        '404':
          description: Пользователь не найден

  /auth/refresh-token:
    post:
      summary: Обновление JWT токена
      tags:
        - Auth
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Токен обновлен
          content:
            application/json:
              schema:
                type: object
                properties:
                  token:
                    type: string
                    example: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'
        '401':
          $ref: "#/components/responses/Unauthorized"

  /auth/resend-registration-sms:
    post:
      summary: Повторная отправка СМС для регистрации
      tags:
        - Auth
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - phone
              properties:
                phone:
                  type: string
                  example: '+79123456789'
      responses:
        '200':
          description: СМС отправлено повторно
        '404':
          description: Регистрация не начата
        '429':
          description: Слишком много запросов

  /auth/resend-login-sms:
    post:
      summary: Повторная отправка СМС для входа
      tags:
        - Auth
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - phone
              properties:
                phone:
                  type: string
                  example: '+79123456789'
      responses:
        '200':
          description: СМС отправлено повторно
        '404':
          description: Пользователь не найден
        '429':
          description: Слишком много запросов

  /users/{userId}:
    get:
      summary: Получить информацию о пользователе
      tags:
        - Users
      security:
        - bearerAuth: []
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"
        '404':
          $ref: "#/components/responses/NotFound"
        '403':
          $ref: "#/components/responses/Unauthorized"

    put:
      summary: Обновить информацию о пользователе
      tags:
        - Users
      security:
        - bearerAuth: []
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UserUpdate"
      responses:
        '200':
          description: Информация обновлена
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"
        '404':
          $ref: "#/components/responses/NotFound"
        '403':
          $ref: "#/components/responses/Unauthorized"

###########################################################
#СОМНИТЕЛЬНО
#ПЕРЕСМОТРЕТЬ НЕОБХОДИМОСТЬ

  /users/{userId}/cars:
    get:
      summary: Получить машины пользователя
      tags:
        - Cars
      security:
        - bearerAuth: []
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/CarWId"
        '404':
          $ref: "#/components/responses/NotFound"
        '403':
          $ref: "#/components/responses/Unauthorized"

    post:
      summary: Добавить машину пользователю
      tags:
        - Cars
      security:
        - bearerAuth: []
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CarWOId"
      responses:
        '200':
          description: Машина добавлена
        '404':
          $ref: "#/components/responses/NotFound"
        '403':
          $ref: "#/components/responses/Unauthorized"

  #############################################
  
  
  /users/{userId}/appointments:
    get:
      summary: Получить записи пользователя
      tags:
        - Appointments
      security:
        - bearerAuth: []
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: status
          in: query
          required: false
          schema:
            type: string
            enum: ['pending', 'confirmed', 'in_progress', 'completed', 'cancelled', 'active']
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            default: 10
        - name: offset
          in: query
          required: false
          schema:
            type: integer
            default: 0
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  appointments:
                    type: array
                    items:
                      $ref: "#/components/schemas/Appointment"
                  total:
                    type: integer
        '404':
          $ref: "#/components/responses/NotFound"
        '403':
          $ref: "#/components/responses/Unauthorized"

  /cars/{carId}:
    get:
      summary: Получить информацию о машине
      tags:
        - Cars
      security:
        - bearerAuth: []
      parameters:
        - name: carId
          in: path
          required: true
          schema:
            type: integer
            format: int64
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CarWId"
        '404':
          $ref: "#/components/responses/NotFound"
        '403':
          $ref: "#/components/responses/Unauthorized"

    delete:
      summary: Удалить машину
      tags:
        - Cars
      security:
        - bearerAuth: []
      parameters:
        - name: carId
          in: path
          required: true
          schema:
            type: integer
            format: int64
      responses:
        '200':
          description: Машина удалена
        '404':
          $ref: "#/components/responses/NotFound"
        '403':
          $ref: "#/components/responses/Unauthorized"

  /car-washes:
    get:
      summary: Получить список автомоек
      tags:
        - CarWashes
      security:
        - bearerAuth: []
      parameters:
        - name: city
          in: query
          required: false
          schema:
            type: string
        - name: latitude
          in: query
          required: false
          schema:
            type: number
            format: float
        - name: longitude
          in: query
          required: false
          schema:
            type: number
            format: float
        - name: serviceId
          in: query
          required: false
          schema:
            type: integer
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/CarWash"

  /car-washes/{carWashId}:
    get:
      summary: Получить детальную информацию о мойке
      tags:
        - CarWashes
      security:
        - bearerAuth: []
      parameters:
        - name: carWashId
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CarWashDetailed"
        '404':
          $ref: "#/components/responses/NotFound"

  /car-washes/{carWashId}/services:
    get:
      summary: Получить услуги мойки
      tags:
        - Services
      security:
        - bearerAuth: []
      parameters:
        - name: carWashId
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Service"
        '404':
          $ref: "#/components/responses/NotFound"

  /car-washes/{carWashId}/slots:
    get:
      summary: Получить доступные слоты для мойки
      tags:
        - Slots
      security:
        - bearerAuth: []
      parameters:
        - name: carWashId
          in: path
          required: true
          schema:
            type: integer
        - name: date
          in: query
          required: true
          schema:
            type: string
            format: date
        - name: serviceId
          in: query
          required: false
          schema:
            type: integer
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Slot"
        '404':
          $ref: "#/components/responses/NotFound"

  /car-washes/{carWashId}/workers:
    get:
      summary: Получить работников мойки
      tags:
        - Workers
      security:
        - bearerAuth: []
      parameters:
        - name: carWashId
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Worker"
        '404':
          $ref: "#/components/responses/NotFound"

  /services:
    get:
      summary: Получить все доступные услуги
      tags:
        - Services
      security:
        - bearerAuth: []
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Service"

  /appointments:
    post:
      summary: Создать запись на мойку
      tags:
        - Appointments
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AppointmentCreate"
      responses:
        '201':
          description: Запись создана
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Appointment"
        '400':
          description: Неверные данные записи
        '409':
          description: Время уже занято

  /appointments/{appointmentId}:
    get:
      summary: Получить информацию о записи
      tags:
        - Appointments
      security:
        - bearerAuth: []
      parameters:
        - name: appointmentId
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Appointment"
        '404':
          $ref: "#/components/responses/NotFound"
        '403':
          $ref: "#/components/responses/Unauthorized"

  /appointments/{appointmentId}/confirm:
    post:
      summary: Подтвердить запись
      tags:
        - Appointments
      security:
        - bearerAuth: []
      parameters:
        - name: appointmentId
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Запись подтверждена
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Appointment"
        '404':
          $ref: "#/components/responses/NotFound"
        '403':
          $ref: "#/components/responses/Unauthorized"
        '409':
          description: Невозможно подтвердить запись

  /appointments/{appointmentId}/cancel:
    post:
      summary: Отменить запись
      tags:
        - Appointments
      security:
        - bearerAuth: []
      parameters:
        - name: appointmentId
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                reason:
                  type: string
      responses:
        '200':
          description: Запись отменена
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Appointment"
        '404':
          $ref: "#/components/responses/NotFound"
        '403':
          $ref: "#/components/responses/Unauthorized"
        '409':
          description: Невозможно отменить запись

  /appointments/{appointmentId}/complete:
    post:
      summary: Завершить запись (для работников)
      tags:
        - Appointments
      security:
        - bearerAuth: []
      parameters:
        - name: appointmentId
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Запись завершена
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Appointment"
        '404':
          $ref: "#/components/responses/NotFound"
        '403':
          $ref: "#/components/responses/Unauthorized"

  /workers:
    get:
      summary: Получить список работников
      tags:
        - Workers
      security:
        - bearerAuth: []
      parameters:
        - name: carWashId
          in: query
          required: false
          schema:
            type: integer
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Worker"

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    User:
      type: object
      required:
        - id
        - phone
        - is_verified
      properties:
        id:
          type: string
          format: uuid
          example: 'd67082e5-1a28-4534-8166-12c2a1abebc2'
        phone:
          type: string
          example: '+79123456789'
        name:
          type: string
          example: 'Иван'
        email:
          type: string
          format: email
          example: 'user@example.com'
        role:
          type: string
          enum: ['customer', 'washer', 'admin']
          example: 'customer'
        is_verified:
          type: boolean
          example: true
        car_wash_id:
          type: integer
          example: 1
        preferences:
          type: object
          properties:
            notifications:
              type: boolean
              example: true
            reminders:
              type: boolean
              example: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    UserUpdate:
      type: object
      properties:
        name:
          type: string
          example: 'Иван'
        email:
          type: string
          format: email
          example: 'user@example.com'
        preferences:
          type: object
          properties:
            notifications:
              type: boolean
            reminders:
              type: boolean

    CarWash:
      type: object
      required:
        - id
        - name
        - address
        - city
      properties:
        id:
          type: integer
          example: 1
        name:
          type: string
          example: 'Мойка №1'
        address:
          type: string
          example: 'ул. Ленина, 1'
        city:
          type: string
          example: 'Москва'
        latitude:
          type: number
          format: float
          example: 55.7558
        longitude:
          type: number
          format: float
          example: 37.6173
        phone:
          type: string
          example: '+74951234567'
        opening_hours:
          type: object
          example: {
            "monday": {"open": "09:00", "close": "21:00"},
            "tuesday": {"open": "09:00", "close": "21:00"}
          }
        is_active:
          type: boolean
          example: true

    CarWashDetailed:
      allOf:
        - $ref: '#/components/schemas/CarWash'
        - type: object
          properties:
            services:
              type: array
              items:
                $ref: "#/components/schemas/Service"
            boxes:
              type: array
              items:
                $ref: "#/components/schemas/Box"
            workers:
              type: array
              items:
                $ref: "#/components/schemas/Worker"

    Service:
      type: object
      required:
        - id
        - name
        - price
      properties:
        id:
          type: integer
          example: 1
        name:
          type: string
          example: 'Комплексная мойка'
        description:
          type: string
          example: 'Полная мойка автомобиля с сушкой'
        price:
          type: number
          format: float
          example: 1500.00
        duration:
          type: integer
          example: 60
        is_active:
          type: boolean
          example: true

    Worker:
      type: object
      required:
        - id
        - name
      properties:
        id:
          type: integer
          example: 1
        name:
          type: string
          example: 'Петр Иванов'
        position:
          type: string
          example: 'мойщик'
        is_active:
          type: boolean
          example: true

    Box:
      type: object
      required:
        - id
        - number
      properties:
        id:
          type: integer
          example: 1
        number:
          type: string
          example: 'A1'
        is_active:
          type: boolean
          example: true

    Slot:
      type: object
      required:
        - id
        - date
        - start_time
        - end_time
        - is_available
      properties:
        id:
          type: integer
          example: 1
        date:
          type: string
          format: date
        start_time:
          type: string
          format: time
        end_time:
          type: string
          format: time
        is_available:
          type: boolean
          example: true
        box_id:
          type: integer
          example: 1

    CommonCarFields:
      type: object
      required:
        - gosNumber
        - bodyType
      properties:
        vin:
          type: string
          example: 'WBAPG7G50BNN17970'
        gosNumber:
          type: string
          example: 'X777XX65'
        make:
          type: string
          example: 'Toyota'
        model:
          type: string
          example: 'Vitz'
        year:
          type: integer
          minimum: 1900
          example: 2011
        bodyType:
          type: string
          example: 'Sedan'

    CarWId:
      allOf:
        - $ref: '#/components/schemas/CommonCarFields'
        - type: object
          required:
            - id
          properties:
            id:
              type: integer
              format: int64
              example: 111111

    CarWOId:
      allOf:
        - $ref: '#/components/schemas/CommonCarFields'
        - type: object

    Appointment:
      type: object
      required:
        - id
        - user_id
        - car_is
        - service_id
        - box_id
        - car_wash_id
        - scheduled_date
        - scheduled_time
        - status
      properties:
        id:
          type: integer
          example: 1
        user_id:
          type: string
          format: uuid
        car_is:
          type: integer
        service_id:
          type: integer
        box_id:
          type: integer
        car_wash_id:
          type: integer
        scheduled_date:
          type: string
          format: date
        scheduled_time:
          type: string
          format: time
        scheduled_end_time:
          type: string
          format: time
        status:
          type: string
          enum: ['pending', 'confirmed', 'in_progress', 'completed', 'cancelled']
        total_price:
          type: number
          format: float
        notes:
          type: string
        created_at:
          type: string
          format: date-time
        service:
          $ref: "#/components/schemas/Service"
        car_wash:
          $ref: "#/components/schemas/CarWash"
        car:
          $ref: "#/components/schemas/CarWId"

    AppointmentCreate:
      type: object
      required:
        - car_is
        - service_id
        - box_id
        - car_wash_id
        - scheduled_date
        - scheduled_time
      properties:
        car_is:
          type: integer
        service_id:
          type: integer
        box_id:
          type: integer
        car_wash_id:
          type: integer
        scheduled_date:
          type: string
          format: date
        scheduled_time:
          type: string
          format: time
        notes:
          type: string
        worker_id:
          type: integer

    Error:
      type: object
      properties:
        code:
          type: integer
          format: int32
          minimum: 1
        message:
          type: string
        details:
          type: object

  responses:
    NotFound:
      description: Сущность не найдена
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
    Unauthorized:
      description: Неавторизованный доступ
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
    BadRequest:
      description: Неверный запрос
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"

security:
  - bearerAuth: []
